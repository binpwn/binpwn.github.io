

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="DingJiayu">
  <meta name="keywords" content="">
  
    <meta name="description" content="JSC和Fuzzilli如何配合的JSC中参数解析下面是wtf&#x2F;NeverDestroyed.h中定义的一个类： 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172&#x2F;&#x2F; FIXME">
<meta property="og:type" content="article">
<meta property="og:title" content="Fuzilli源码解析3">
<meta property="og:url" content="https://binpwn.github.io/2024/06/08/Fuzilli%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%903/index.html">
<meta property="og:site_name" content="binpwn&#39;s blog">
<meta property="og:description" content="JSC和Fuzzilli如何配合的JSC中参数解析下面是wtf&#x2F;NeverDestroyed.h中定义的一个类： 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172&#x2F;&#x2F; FIXME">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-06-08T14:34:10.000Z">
<meta property="article:modified_time" content="2024-09-08T14:35:53.463Z">
<meta property="article:author" content="DingJiayu">
<meta property="article:tag" content="Fuzzilli">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>Fuzilli源码解析3 - binpwn&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"binpwn.github.io","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.1.1"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>binpwn&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Fuzilli源码解析3"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-06-08 22:34" pubdate>
          2024年6月8日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          5.3k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          45 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Fuzilli源码解析3</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="JSC和Fuzzilli如何配合的"><a href="#JSC和Fuzzilli如何配合的" class="headerlink" title="JSC和Fuzzilli如何配合的"></a>JSC和Fuzzilli如何配合的</h1><h2 id="JSC中"><a href="#JSC中" class="headerlink" title="JSC中"></a>JSC中</h2><h3 id="参数解析"><a href="#参数解析" class="headerlink" title="参数解析"></a>参数解析</h3><p>下面是<code>wtf/NeverDestroyed.h</code>中定义的一个类：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// <span class="hljs-doctag">FIXME:</span> It&#x27;s messy to have to repeat the whole class just to make this &quot;lazy&quot; version.</span><br><span class="hljs-comment">// Should revisit clients to see if we really need this, and perhaps use templates to</span><br><span class="hljs-comment">// share more of the code with the main NeverDestroyed above.</span><br><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T, <span class="hljs-keyword">typename</span> AccessTraits&gt; <span class="hljs-keyword">class</span> <span class="hljs-title class_">LazyNeverDestroyed</span> &#123;<br>    <span class="hljs-built_in">WTF_MAKE_NONCOPYABLE</span>(LazyNeverDestroyed);<br>    WTF_FORBID_HEAP_ALLOCATION;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">LazyNeverDestroyed</span>() = <span class="hljs-keyword">default</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span>... Args&gt;</span><br><span class="hljs-function">    <span class="hljs-type">void</span> <span class="hljs-title">construct</span><span class="hljs-params">(Args&amp;&amp;... args)</span></span><br><span class="hljs-function">    </span>&#123;<br>        AccessTraits::<span class="hljs-built_in">assertAccess</span>();<br>        <span class="hljs-built_in">constructWithoutAccessCheck</span>(std::forward&lt;Args&gt;(args)...);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span>... Args&gt;</span><br><span class="hljs-function">    <span class="hljs-type">void</span> <span class="hljs-title">constructWithoutAccessCheck</span><span class="hljs-params">(Args&amp;&amp;... args)</span></span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-built_in">ASSERT</span>(!m_isConstructed);<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> ASSERT_ENABLED</span><br>        m_isConstructed = <span class="hljs-literal">true</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>        <span class="hljs-built_in">MaybeRelax</span>&lt;T&gt;(<span class="hljs-built_in">new</span> (<span class="hljs-built_in">storagePointerWithoutAccessCheck</span>()) <span class="hljs-built_in">T</span>(std::forward&lt;Args&gt;(args)...));<br>    &#125;<br><br>    <span class="hljs-keyword">operator</span> T&amp;() &#123; <span class="hljs-keyword">return</span> *<span class="hljs-built_in">storagePointer</span>(); &#125;<br>    <span class="hljs-function">T&amp; <span class="hljs-title">get</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">return</span> *<span class="hljs-built_in">storagePointer</span>(); &#125;<br><br>    T* <span class="hljs-keyword">operator</span>-&gt;() &#123; <span class="hljs-keyword">return</span> <span class="hljs-built_in">storagePointer</span>(); &#125;<br><br>    <span class="hljs-keyword">operator</span> <span class="hljs-type">const</span> T&amp;() <span class="hljs-type">const</span> &#123; <span class="hljs-keyword">return</span> *<span class="hljs-built_in">storagePointer</span>(); &#125;<br>    <span class="hljs-function"><span class="hljs-type">const</span> T&amp; <span class="hljs-title">get</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> *<span class="hljs-built_in">storagePointer</span>(); &#125;<br><br>    <span class="hljs-type">const</span> T* <span class="hljs-keyword">operator</span>-&gt;() <span class="hljs-type">const</span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-built_in">storagePointer</span>(); &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> ASSERT_ENABLED</span><br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">isConstructed</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> m_isConstructed; &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-keyword">using</span> PointerType = <span class="hljs-keyword">typename</span> std::remove_const&lt;T&gt;::type*;<br><br>    <span class="hljs-function">PointerType <span class="hljs-title">storagePointerWithoutAccessCheck</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-built_in">ASSERT</span>(m_isConstructed);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">const_cast</span>&lt;PointerType&gt;(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> T*&gt;(&amp;m_storage));<br>    &#125;<br><br>    <span class="hljs-function">PointerType <span class="hljs-title">storagePointer</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span><br><span class="hljs-function">    </span>&#123;<br>        AccessTraits::<span class="hljs-built_in">assertAccess</span>();<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">storagePointerWithoutAccessCheck</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> PtrType, <span class="hljs-type">bool</span> ShouldRelax = std::is_base_of&lt;RefCountedBase, PtrType&gt;::value&gt; <span class="hljs-keyword">struct</span> MaybeRelax &#123;<br>        <span class="hljs-keyword">explicit</span> <span class="hljs-built_in">MaybeRelax</span>(PtrType*) &#123; &#125;<br>    &#125;;<br>    <span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> PtrType&gt; <span class="hljs-keyword">struct</span> <span class="hljs-title class_">MaybeRelax</span>&lt;PtrType, <span class="hljs-literal">true</span>&gt; &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">MaybeRelax</span><span class="hljs-params">(PtrType* ptr)</span> </span>&#123; ptr-&gt;<span class="hljs-built_in">relaxAdoptionRequirement</span>(); &#125;<br>    &#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> ASSERT_ENABLED</span><br>    <span class="hljs-comment">// LazyNeverDestroyed objects are always static, so this variable is initialized to false.</span><br>    <span class="hljs-comment">// It must not be initialized dynamically; that would not be thread safe.</span><br>    <span class="hljs-type">bool</span> m_isConstructed;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-comment">// <span class="hljs-doctag">FIXME:</span> Investigate whether we should allocate a hunk of virtual memory</span><br>    <span class="hljs-comment">// and hand out chunks of it to NeverDestroyed instead, to reduce fragmentation.</span><br>    <span class="hljs-keyword">typename</span> std::aligned_storage&lt;<span class="hljs-built_in">sizeof</span>(T), std::alignment_of&lt;T&gt;::value&gt;::type m_storage;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>在<code>jsc.cpp</code>中定义了<code>CommandLine</code>类，并且还定义了一个<code>LazyNeverDestroyed&lt;CommandLine&gt;</code>静态对象<code>mainCommandLine</code>，可以看到在其构造函数中调用了<code>parseArguments</code>：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CommandLine</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">CommandLine</span>(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)<br>    &#123;<br>        <span class="hljs-built_in">parseArguments</span>(argc, argv);<br>    &#125;<br><br>    <span class="hljs-keyword">enum</span> <span class="hljs-title class_">CommandLineForWorkersTag</span> &#123; CommandLineForWorkers &#125;;<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">CommandLine</span><span class="hljs-params">(CommandLineForWorkersTag)</span></span>;<br><br>    Vector&lt;Script&gt; m_scripts;<br>    Vector&lt;String&gt; m_arguments;<br>    String m_profilerOutput;<br>    String m_uncaughtExceptionName;<br>    <span class="hljs-type">bool</span> m_interactive &#123; <span class="hljs-literal">false</span> &#125;;<br>    <span class="hljs-type">bool</span> m_reprl &#123; <span class="hljs-literal">false</span> &#125;;<br>    <span class="hljs-type">bool</span> m_dump &#123; <span class="hljs-literal">false</span> &#125;;<br>    <span class="hljs-type">bool</span> m_module &#123; <span class="hljs-literal">false</span> &#125;;<br>    <span class="hljs-type">bool</span> m_exitCode &#123; <span class="hljs-literal">false</span> &#125;;<br>    <span class="hljs-type">bool</span> m_destroyVM &#123; <span class="hljs-literal">false</span> &#125;;<br>    <span class="hljs-type">bool</span> m_treatWatchdogExceptionAsSuccess &#123; <span class="hljs-literal">false</span> &#125;;<br>    <span class="hljs-type">bool</span> m_alwaysDumpUncaughtException &#123; <span class="hljs-literal">false</span> &#125;;<br>    <span class="hljs-type">bool</span> m_dumpMemoryFootprint &#123; <span class="hljs-literal">false</span> &#125;;<br>    <span class="hljs-type">bool</span> m_dumpLinkBufferStats &#123; <span class="hljs-literal">false</span> &#125;;<br>    <span class="hljs-type">bool</span> m_dumpSamplingProfilerData &#123; <span class="hljs-literal">false</span> &#125;;<br>    <span class="hljs-type">bool</span> m_enableRemoteDebugging &#123; <span class="hljs-literal">false</span> &#125;;<br>    <span class="hljs-type">bool</span> m_canBlockIsFalse &#123; <span class="hljs-literal">false</span> &#125;;<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">parseArguments</span><span class="hljs-params">(<span class="hljs-type">int</span>, <span class="hljs-type">char</span>**)</span></span>;<br>&#125;;<br><span class="hljs-type">static</span> LazyNeverDestroyed&lt;CommandLine&gt; mainCommandLine;<br></code></pre></td></tr></table></figure>

<p>看下<code>parseArguments</code>函数的部分代码，主要解析参数根据不同的参数来设置，比如下面关注<code>--reprl</code>选项，<code>m_scripts</code>是一个向量，<code>--reprl</code>向其中加入一个<code>Script</code>对象并且<code>CodeSource</code>是<code>Script::CodeSource::REPRL</code>：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CommandLine::parseArguments</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span></span><br><span class="hljs-function"></span>&#123;<br>    Options::AllowUnfinalizedAccessScope scope;<br>    Options::<span class="hljs-built_in">initialize</span>();<br>    Options::<span class="hljs-built_in">useSharedArrayBuffer</span>() = <span class="hljs-literal">true</span>;<br>    Options::<span class="hljs-built_in">useAtMethod</span>() = <span class="hljs-literal">true</span>;<br>    <br><span class="hljs-meta">#<span class="hljs-keyword">if</span> PLATFORM(IOS_FAMILY)</span><br>    Options::<span class="hljs-built_in">crashIfCantAllocateJITMemory</span>() = <span class="hljs-literal">true</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-keyword">if</span> (Options::<span class="hljs-built_in">dumpOptions</span>()) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Command line:&quot;</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> PLATFORM(COCOA)</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">char</span>** envp = *_NSGetEnviron(); *envp; envp++) &#123;<br>            <span class="hljs-type">const</span> <span class="hljs-type">char</span>* env = *envp;<br>            <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strncmp</span>(<span class="hljs-string">&quot;JSC_&quot;</span>, env, <span class="hljs-number">4</span>))<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; %s&quot;</span>, env);<br>        &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// PLATFORM(COCOA)</span></span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; argc; ++i)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; %s&quot;</span>, argv[i]);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-type">int</span> i = <span class="hljs-number">1</span>;<br>    JSC::Options::DumpLevel dumpOptionsLevel = JSC::Options::DumpLevel::None;<br>    <span class="hljs-type">bool</span> needToExit = <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-type">bool</span> hasBadJSCOptions = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">for</span> (; i &lt; argc; ++i) &#123;<br>        <span class="hljs-type">const</span> <span class="hljs-type">char</span>* arg = argv[i];<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(arg, <span class="hljs-string">&quot;-f&quot;</span>)) &#123;<br>            <span class="hljs-keyword">if</span> (++i == argc)<br>                <span class="hljs-built_in">printUsageStatement</span>();<br>            m_scripts.<span class="hljs-built_in">append</span>(<span class="hljs-built_in">Script</span>(Script::StrictMode::Sloppy, Script::CodeSource::File, Script::ScriptType::Script, argv[i]));<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(arg, <span class="hljs-string">&quot;-e&quot;</span>)) &#123;<br>            <span class="hljs-keyword">if</span> (++i == argc)<br>                <span class="hljs-built_in">printUsageStatement</span>();<br>            m_scripts.<span class="hljs-built_in">append</span>(<span class="hljs-built_in">Script</span>(Script::StrictMode::Sloppy, Script::CodeSource::CommandLine, Script::ScriptType::Script, argv[i]));<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(arg, <span class="hljs-string">&quot;-i&quot;</span>)) &#123;<br>            m_interactive = <span class="hljs-literal">true</span>;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(arg, <span class="hljs-string">&quot;--reprl&quot;</span>)) &#123;<br>            m_reprl = <span class="hljs-literal">true</span>;<br>            m_scripts.<span class="hljs-built_in">append</span>(<span class="hljs-built_in">Script</span>(Script::StrictMode::Sloppy, Script::CodeSource::REPRL, Script::ScriptType::Script, <span class="hljs-literal">nullptr</span>));<br>            <span class="hljs-keyword">continue</span>;<br></code></pre></td></tr></table></figure>

<p><code>--reprl</code>参数从哪来的呢？去<code>Fuzzilli</code>中看下<code>jscProfile</code>，发现参数在这里添加的：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs swift">getProcessArguments: &#123; (randomizingArguments: <span class="hljs-type">Bool</span>) -&gt; [<span class="hljs-type">String</span>] <span class="hljs-keyword">in</span><br>        <span class="hljs-keyword">var</span> args <span class="hljs-operator">=</span> [<br>            <span class="hljs-string">&quot;--validateOptions=true&quot;</span>,<br>            <span class="hljs-comment">// No need to call functions thousands of times before they are JIT compiled</span><br>            <span class="hljs-string">&quot;--thresholdForJITSoon=10&quot;</span>,<br>            <span class="hljs-string">&quot;--thresholdForJITAfterWarmUp=10&quot;</span>,<br>            <span class="hljs-string">&quot;--thresholdForOptimizeAfterWarmUp=100&quot;</span>,<br>            <span class="hljs-string">&quot;--thresholdForOptimizeAfterLongWarmUp=100&quot;</span>,<br>            <span class="hljs-string">&quot;--thresholdForOptimizeSoon=100&quot;</span>,<br>            <span class="hljs-string">&quot;--thresholdForFTLOptimizeAfterWarmUp=1000&quot;</span>,<br>            <span class="hljs-string">&quot;--thresholdForFTLOptimizeSoon=1000&quot;</span>,<br>            <span class="hljs-comment">// Enable bounds check elimination validation</span><br>            <span class="hljs-string">&quot;--validateBCE=true&quot;</span>,<br>            <span class="hljs-string">&quot;--reprl&quot;</span>]<br></code></pre></td></tr></table></figure>



<h3 id="runJSC向Fuzzilli打招呼"><a href="#runJSC向Fuzzilli打招呼" class="headerlink" title="runJSC向Fuzzilli打招呼"></a>runJSC向Fuzzilli打招呼</h3><p>在<code>jscmain</code>函数中有以下语句：最后是<code>runJSC</code>中调用的<code>runWithOptions</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs C++">    <span class="hljs-type">int</span> result = <span class="hljs-built_in">runJSC</span>(<br>        mainCommandLine.<span class="hljs-built_in">get</span>(), <span class="hljs-literal">false</span>,<br>        [&amp;] (VM&amp; vm, GlobalObject* globalObject, <span class="hljs-type">bool</span>&amp; success) &#123;<br>            <span class="hljs-built_in">UNUSED_PARAM</span>(vm);<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> PLATFORM(COCOA)</span><br>            vm.<span class="hljs-built_in">setOnEachMicrotaskTick</span>(<span class="hljs-built_in">WTFMove</span>(onEachMicrotaskTick));<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>            <span class="hljs-built_in">runWithOptions</span>(globalObject, mainCommandLine.<span class="hljs-built_in">get</span>(), success);<br>        &#125;);<br></code></pre></td></tr></table></figure>

<p>下面是新加的内容，主要来配合fuzz</p>
<h4 id="12-41行"><a href="#12-41行" class="headerlink" title="12 - 41行"></a>12 - 41行</h4><p>​	首先是向写控制管道写<code>HELO</code>，然后再从读控制管道读取内容，相当于<code>Fuzzilli</code>和<code>JSC</code>的一次握手过程。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">// mmap函数就是将文件的内容或者匿名内存直接映射到进程的虚拟内存中，使得进程可以像访问普通内存一样访问文件的内容。</span><br><span class="hljs-type">void</span> *<span class="hljs-title function_">mmap</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr, <span class="hljs-type">size_t</span> length, <span class="hljs-type">int</span> prot, <span class="hljs-type">int</span> flags, <span class="hljs-type">int</span> fd, <span class="hljs-type">off_t</span> offset)</span>;<br><span class="hljs-comment">// addr: 建议的起始地址，通常设置为NULL，由系统分配。</span><br><span class="hljs-comment">// length: 要映射的字节数</span><br><span class="hljs-comment">// prot: 映射区域的保护方式，如PROT_READ、PROT_WRITE、PROT_EXEC等</span><br><span class="hljs-comment">// flags: 映射选项，如MAP_SHARED、MAP_PRIVATE等。</span><br><span class="hljs-comment">// MAP_SHARED: 多进程对映射区域的修改会立即反映到原始文件中，并且其他进程也会看到这些修改。</span><br><span class="hljs-comment">// MAP_PRIVATE: 当多个进程对同一个文件进行映射，每个进程都会得到一个私有的拷贝，对映射区域的修改只影响当前进程。</span><br><span class="hljs-comment">// fd: 文件描述符，用于指定要映射的文件。</span><br><span class="hljs-comment">// mmap函数中的fd参数是用来指定要映射的文件或共享内存对象的，每个进程都有自己的独立的文件描述符表。</span><br><span class="hljs-comment">// offset: 文件的偏移量，从该偏移量开始映射。</span><br><br><span class="hljs-comment">// 下面是将REPRL读数据缓冲区映射到当前进程，它是一个共享内存对象</span><br>reprl_input_data = (<span class="hljs-type">char</span>*)mmap(<span class="hljs-number">0</span>, REPRL_MAX_DATA_SIZE, PROT_READ | PROT_WRITE, MAP_SHARED, REPRL_DRFD, <span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure>

<p>​	然后加了一个<code>do while</code>循环用于<code>reprl</code>，在<code>do while</code>循环的起始部分首先是从控制中读取内容，判断是否为指定的操作，如果不是<code>cexe</code>则退出，否则继续向下执行</p>
<h4 id="56行"><a href="#56行" class="headerlink" title="56行"></a>56行</h4><p>这里是加了一个判断，首先是没开启<code>reprl</code>模式，接着是开启了交互模式，并且<code>success</code>是<code>true</code>，然后才会开启<code>jsc</code>的交互模式，就是在命令行中直接运行<code>jsc</code>的一个状态。</p>
<h4 id="125-141行"><a href="#125-141行" class="headerlink" title="125 - 141行"></a>125 - 141行</h4><p>可以看到在<code>do while</code>的尾部也加入了一个<code>if</code>判断，如果是<code>reprl</code>模式需要先刷新一下缓冲区，然后接着判断是否有未处理的请求，如果有就设<code>result</code>为<code>1</code>表示出错了。可以看到是通过写控制向Fuzzilli传递程序状态信息。</p>
<blockquote>
<p>正常状态下，result有三个值可以返回：</p>
<p>0：执行成功，在下面第60行result &#x3D; success &amp;&amp; (asyncTestExpectedPasses &#x3D;&#x3D; asyncTestPasses) ? 0 : 3;</p>
<p>1：出现意外，比如有未处理的promise，在下面第132行result &#x3D; 1;</p>
<p>3：执行失败，在下面第60行result &#x3D; success &amp;&amp; (asyncTestExpectedPasses &#x3D;&#x3D; asyncTestPasses) ? 0 : 3;</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> Func&gt;</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">runJSC</span><span class="hljs-params">(<span class="hljs-type">const</span> CommandLine&amp; options, <span class="hljs-type">bool</span> isWorker, <span class="hljs-type">const</span> Func&amp; func)</span></span><br><span class="hljs-function"></span>&#123;<br><br>    <span class="hljs-function">Worker <span class="hljs-title">worker</span><span class="hljs-params">(Workers::singleton(), !isWorker)</span></span>;<br>    <br>    VM&amp; vm = VM::<span class="hljs-built_in">create</span>(HeapType::Large).<span class="hljs-built_in">leakRef</span>();<br>    <span class="hljs-keyword">if</span> (!isWorker &amp;&amp; options.m_canBlockIsFalse)<br>        vm.m_typedArrayController = <span class="hljs-built_in">adoptRef</span>(<span class="hljs-keyword">new</span> JSC::<span class="hljs-built_in">SimpleTypedArrayController</span>(<span class="hljs-literal">false</span>));<br><br>    <span class="hljs-type">int</span> result;<br>    <span class="hljs-type">bool</span> success;<br><br>    <span class="hljs-comment">// Let parent know we are ready</span><br>    <span class="hljs-keyword">if</span> (options.m_reprl) &#123;<br>        <span class="hljs-type">char</span> helo[] = <span class="hljs-string">&quot;HELO&quot;</span>;<br>        <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">write</span>(REPRL_CWFD, helo, <span class="hljs-number">4</span>) == <span class="hljs-number">4</span>);<br>        <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">read</span>(REPRL_CRFD, helo, <span class="hljs-number">4</span>) == <span class="hljs-number">4</span>);<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">memcmp</span>(helo, <span class="hljs-string">&quot;HELO&quot;</span>, <span class="hljs-number">4</span>) != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;[REPRL] Invalid response from parent\n&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br><br>        <span class="hljs-comment">// Mmap the data input buffer.</span><br>        reprl_input_data = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">mmap</span>(<span class="hljs-number">0</span>, REPRL_MAX_DATA_SIZE, PROT_READ | PROT_WRITE, MAP_SHARED, REPRL_DRFD, <span class="hljs-number">0</span>);<br>        <span class="hljs-built_in">CHECK</span>(reprl_input_data != MAP_FAILED);<br>    &#125;<br><br>    <span class="hljs-keyword">do</span> &#123;<br>    <span class="hljs-comment">// Keep indention for easier diffing</span><br>    <span class="hljs-keyword">if</span> (options.m_reprl) &#123;<br>        <span class="hljs-type">unsigned</span> action;<br>        <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">read</span>(REPRL_CRFD, &amp;action, <span class="hljs-number">4</span>) == <span class="hljs-number">4</span>);<br>        <span class="hljs-keyword">if</span> (action != <span class="hljs-string">&#x27;cexe&#x27;</span>) &#123;<br>            <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;[REPRL] Unknown action: %u\n&quot;</span>, action);<br>            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br>    &#125;<br><br>    success = <span class="hljs-literal">true</span>;<br><br>    GlobalObject* globalObject = <span class="hljs-literal">nullptr</span>;<br>    &#123;<br>        <span class="hljs-function">JSLockHolder <span class="hljs-title">locker</span><span class="hljs-params">(vm)</span></span>;<br><br>        <span class="hljs-built_in">startTimeoutThreadIfNeeded</span>(vm);<br>        globalObject = GlobalObject::<span class="hljs-built_in">create</span>(vm, GlobalObject::<span class="hljs-built_in">createStructure</span>(vm, <span class="hljs-built_in">jsNull</span>()), options.m_arguments);<br>        globalObject-&gt;<span class="hljs-built_in">setRemoteDebuggingEnabled</span>(options.m_enableRemoteDebugging);<br>        <span class="hljs-built_in">func</span>(vm, globalObject, success);<br>        vm.<span class="hljs-built_in">drainMicrotasks</span>();<br>    &#125;<br>    vm.deferredWorkTimer-&gt;<span class="hljs-built_in">runRunLoop</span>();<br>    &#123;<br>        <span class="hljs-function">JSLockHolder <span class="hljs-title">locker</span><span class="hljs-params">(vm)</span></span>;<br>        <span class="hljs-keyword">if</span> (!options.m_reprl &amp;&amp; options.m_interactive &amp;&amp; success)<br>            <span class="hljs-built_in">runInteractive</span>(globalObject);<br>    &#125;<br><br>    result = success &amp;&amp; (asyncTestExpectedPasses == asyncTestPasses) ? <span class="hljs-number">0</span> : <span class="hljs-number">3</span>;<br><br>    <span class="hljs-keyword">if</span> (options.m_exitCode) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;jsc exiting %d&quot;</span>, result);<br>        <span class="hljs-keyword">if</span> (asyncTestExpectedPasses != asyncTestPasses)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; because expected: %d async test passes but got: %d async test passes&quot;</span>, asyncTestExpectedPasses, asyncTestPasses);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (Options::<span class="hljs-built_in">useProfiler</span>()) &#123;<br>        <span class="hljs-function">JSLockHolder <span class="hljs-title">locker</span><span class="hljs-params">(vm)</span></span>;<br>        <span class="hljs-keyword">if</span> (!vm.m_perBytecodeProfiler-&gt;<span class="hljs-built_in">save</span>(options.m_profilerOutput.<span class="hljs-built_in">utf8</span>().<span class="hljs-built_in">data</span>()))<br>            <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;could not save profiler output.\n&quot;</span>);<br>    &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> ENABLE(JIT)</span><br>    &#123;<br>        <span class="hljs-function">JSLockHolder <span class="hljs-title">locker</span><span class="hljs-params">(vm)</span></span>;<br>        <span class="hljs-keyword">if</span> (Options::<span class="hljs-built_in">useExceptionFuzz</span>())<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;JSC EXCEPTION FUZZ: encountered %u checks.\n&quot;</span>, <span class="hljs-built_in">numberOfExceptionFuzzChecks</span>());<br>        <span class="hljs-type">bool</span> fireAtEnabled = Options::<span class="hljs-built_in">fireExecutableAllocationFuzzAt</span>() || Options::<span class="hljs-built_in">fireExecutableAllocationFuzzAtOrAfter</span>();<br>        <span class="hljs-keyword">if</span> (Options::<span class="hljs-built_in">verboseExecutableAllocationFuzz</span>() &amp;&amp; Options::<span class="hljs-built_in">useExecutableAllocationFuzz</span>() &amp;&amp; !fireAtEnabled)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;JSC EXECUTABLE ALLOCATION FUZZ: encountered %u checks.\n&quot;</span>, <span class="hljs-built_in">numberOfExecutableAllocationFuzzChecks</span>());<br>        <span class="hljs-keyword">if</span> (Options::<span class="hljs-built_in">useOSRExitFuzz</span>() &amp;&amp; Options::<span class="hljs-built_in">verboseOSRExitFuzz</span>()) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;JSC OSR EXIT FUZZ: encountered %u static checks.\n&quot;</span>, <span class="hljs-built_in">numberOfStaticOSRExitFuzzChecks</span>());<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;JSC OSR EXIT FUZZ: encountered %u dynamic checks.\n&quot;</span>, <span class="hljs-built_in">numberOfOSRExitFuzzChecks</span>());<br>        &#125;<br><br>        <br>        <span class="hljs-keyword">auto</span> compileTimeStats = JIT::<span class="hljs-built_in">compileTimeStats</span>();<br>        Vector&lt;CString&gt; compileTimeKeys;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; entry : compileTimeStats)<br>            compileTimeKeys.<span class="hljs-built_in">append</span>(entry.key);<br>        std::<span class="hljs-built_in">sort</span>(compileTimeKeys.<span class="hljs-built_in">begin</span>(), compileTimeKeys.<span class="hljs-built_in">end</span>());<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> CString&amp; key : compileTimeKeys) &#123;<br>            <span class="hljs-keyword">if</span> (key.<span class="hljs-built_in">data</span>())<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%40s: %.3lf ms\n&quot;</span>, key.<span class="hljs-built_in">data</span>(), compileTimeStats.<span class="hljs-built_in">get</span>(key).<span class="hljs-built_in">milliseconds</span>());<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (Options::<span class="hljs-built_in">reportTotalPhaseTimes</span>())<br>            <span class="hljs-built_in">logTotalPhaseTimes</span>();<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-keyword">if</span> (Options::<span class="hljs-built_in">gcAtEnd</span>()) &#123;<br>        <span class="hljs-comment">// We need to hold the API lock to do a GC.</span><br>        <span class="hljs-function">JSLockHolder <span class="hljs-title">locker</span><span class="hljs-params">(&amp;vm)</span></span>;<br>        vm.heap.<span class="hljs-built_in">collectNow</span>(Sync, CollectionScope::Full);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (options.m_dumpSamplingProfilerData) &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> ENABLE(SAMPLING_PROFILER)</span><br>        <span class="hljs-function">JSLockHolder <span class="hljs-title">locker</span><span class="hljs-params">(&amp;vm)</span></span>;<br>        vm.<span class="hljs-built_in">samplingProfiler</span>()-&gt;<span class="hljs-built_in">reportTopFunctions</span>();<br>        vm.<span class="hljs-built_in">samplingProfiler</span>()-&gt;<span class="hljs-built_in">reportTopBytecodes</span>();<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>        <span class="hljs-built_in">dataLog</span>(<span class="hljs-string">&quot;Sampling profiler is not enabled on this platform\n&quot;</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> ENABLE(JIT)</span><br>    <span class="hljs-keyword">if</span> (vm.jitSizeStatistics)<br>        <span class="hljs-built_in">dataLogLn</span>(*vm.jitSizeStatistics);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-keyword">if</span> (options.m_reprl) &#123;<br>        <span class="hljs-comment">// In REPRL mode, stdout and stderr may be regular files, so we need to fflush them here.</span><br>        <span class="hljs-built_in">fflush</span>(stdout);<br>        <span class="hljs-built_in">fflush</span>(stderr);<br><br>        <span class="hljs-comment">// Check if any rejected promises weren&#x27;t handled</span><br>        <span class="hljs-keyword">if</span> (numPendingRejectedPromises &gt; <span class="hljs-number">0</span>) &#123;<br>            result = <span class="hljs-number">1</span>;<br>            numPendingRejectedPromises = <span class="hljs-number">0</span>;<br>        &#125;<br><br>        <span class="hljs-type">int</span> status = (result &amp; <span class="hljs-number">0xff</span>) &lt;&lt; <span class="hljs-number">8</span>;<br>        <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">write</span>(REPRL_CWFD, &amp;status, <span class="hljs-number">4</span>) == <span class="hljs-number">4</span>);<br>        __sanitizer_cov_reset_edgeguards();<br>    &#125;<br><br>    &#125; <span class="hljs-keyword">while</span> (options.m_reprl);<br><br>    <span class="hljs-keyword">if</span> (options.m_destroyVM || isWorker) &#123;<br>        <span class="hljs-function">JSLockHolder <span class="hljs-title">locker</span><span class="hljs-params">(vm)</span></span>;<br>        <span class="hljs-comment">// This is needed because we don&#x27;t want the worker&#x27;s main</span><br>        <span class="hljs-comment">// thread to die before its compilation threads finish.</span><br>        vm.<span class="hljs-built_in">deref</span>();<br>    &#125;<br><br>    vm.<span class="hljs-built_in">codeCache</span>()-&gt;<span class="hljs-built_in">write</span>();<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="runWithOptions读取脚本"><a href="#runWithOptions读取脚本" class="headerlink" title="runWithOptions读取脚本"></a>runWithOptions读取脚本</h3><p>上面可以看到在<code>runJSC</code>函数的第50行调用了<code>func</code>函数，紧接着调用了<code>runWithOptions</code>函数，<code>runWithOptions</code>的执行影响<code>success</code>，从而影响最后的<code>result</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">// func函数</span><br>[&amp;] (VM&amp; vm, GlobalObject* globalObject, <span class="hljs-type">bool</span>&amp; success) &#123;<br>            UNUSED_PARAM(vm);<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> PLATFORM(COCOA)</span><br>            vm.setOnEachMicrotaskTick(WTFMove(onEachMicrotaskTick));<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>            runWithOptions(globalObject, mainCommandLine.get(), success);<br>        &#125;<br></code></pre></td></tr></table></figure>

<h4 id="17-25行"><a href="#17-25行" class="headerlink" title="17-25行"></a>17-25行</h4><p>在没有这几行时，原来可能就<code>Script::CodeSource::File</code>或<code>Script::CodeSource::CommandLine</code>，所以一个<code>if else</code>就能解决。然后现在是加入了一个<code>Script::CodeSource::REPRL</code>，所以需要<code>if 、else if</code>和<code>else</code>。</p>
<p>下面新添加的几行就是处理<code>Script::CodeSource::REPRL</code>这种情况 ：</p>
<blockquote>
<p>从读控制中读取8个字节到script_size表示脚本的大小，保证不超过REPRL_MAX_SIZE</p>
<p>调整scriptBuffer大小为script_size，然后从reprl_input_data中读取数据到脚本缓冲区中</p>
</blockquote>
<p>接着分析了下，正常应该是72行的<code>evaluate</code>函数来执行代码，跟踪了下<code>success</code>，发现若中间出现异常则将<code>success</code>置为<code>false</code>，由于进入此函数之前<code>success</code>的默认值是<code>true</code>，所以<code>success</code>主要还是用来判断是否出现了异常情况</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">runWithOptions</span><span class="hljs-params">(GlobalObject* globalObject, CommandLine&amp; options, <span class="hljs-type">bool</span>&amp; success)</span></span><br><span class="hljs-function"></span>&#123;<br>    Vector&lt;Script&gt;&amp; scripts = options.m_scripts;<br>    String fileName;<br>    Vector&lt;<span class="hljs-type">char</span>&gt; scriptBuffer;<br><br>    VM&amp; vm = globalObject-&gt;<span class="hljs-built_in">vm</span>();<br>    <span class="hljs-keyword">auto</span> scope = <span class="hljs-built_in">DECLARE_CATCH_SCOPE</span>(vm);<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> ENABLE(SAMPLING_FLAGS)</span><br>    SamplingFlags::<span class="hljs-built_in">start</span>();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; scripts.<span class="hljs-built_in">size</span>(); i++) &#123;<br>        JSInternalPromise* promise = <span class="hljs-literal">nullptr</span>;<br>        <span class="hljs-type">bool</span> isModule = options.m_module || scripts[i].scriptType == Script::ScriptType::Module;<br>        <span class="hljs-keyword">if</span> (scripts[i].codeSource == Script::CodeSource::REPRL) &#123;<br>            <span class="hljs-type">size_t</span> script_size;<br>            <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">read</span>(REPRL_CRFD, &amp;script_size, <span class="hljs-number">8</span>) == <span class="hljs-number">8</span>);<br>            <span class="hljs-built_in">CHECK</span>(script_size &lt; REPRL_MAX_DATA_SIZE);<br>            scriptBuffer.<span class="hljs-built_in">resize</span>(script_size);<br>            <span class="hljs-type">char</span>* ptr = scriptBuffer.<span class="hljs-built_in">data</span>();<br>            <span class="hljs-built_in">memcpy</span>(ptr, reprl_input_data, script_size);<br>            fileName = <span class="hljs-string">&quot;[REPRL]&quot;</span>_s;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (scripts[i].codeSource == Script::CodeSource::File) &#123;<br>            fileName = String::<span class="hljs-built_in">fromLatin1</span>(scripts[i].argument);<br>            <span class="hljs-keyword">if</span> (scripts[i].strictMode == Script::StrictMode::Strict)<br>                scriptBuffer.<span class="hljs-built_in">append</span>(<span class="hljs-string">&quot;\&quot;use strict\&quot;;\n&quot;</span>, <span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;\&quot;use strict\&quot;;\n&quot;</span>));<br><br>            <span class="hljs-keyword">if</span> (isModule) &#123;<br>                <span class="hljs-comment">// If necessary, prepend &quot;./&quot; so the module loader doesn&#x27;t think this is a bare-name specifier.</span><br>                fileName = <span class="hljs-built_in">isAbsolutePath</span>(fileName) || <span class="hljs-built_in">isDottedRelativePath</span>(fileName) ? fileName : <span class="hljs-built_in">makeString</span>(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-built_in">pathSeparator</span>(), fileName);<br>                promise = <span class="hljs-built_in">loadAndEvaluateModule</span>(globalObject, fileName, <span class="hljs-built_in">jsUndefined</span>(), <span class="hljs-built_in">jsUndefined</span>());<br>                <span class="hljs-built_in">RETURN_IF_EXCEPTION</span>(scope, <span class="hljs-built_in">void</span>());<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">fetchScriptFromLocalFileSystem</span>(fileName, scriptBuffer)) &#123;<br>                    success = <span class="hljs-literal">false</span>; <span class="hljs-comment">// fail early so we can catch missing files</span><br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">size_t</span> commandLineLength = <span class="hljs-built_in">strlen</span>(scripts[i].argument);<br>            scriptBuffer.<span class="hljs-built_in">resize</span>(commandLineLength);<br>            std::<span class="hljs-built_in">copy</span>(scripts[i].argument, scripts[i].argument + commandLineLength, scriptBuffer.<span class="hljs-built_in">begin</span>());<br>            fileName = <span class="hljs-string">&quot;[Command Line]&quot;</span>_s;<br>        &#125;<br><br>        <span class="hljs-type">bool</span> isLastFile = i == scripts.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>;<br>        SourceOrigin sourceOrigin &#123; <span class="hljs-built_in">absoluteFileURL</span>(fileName) &#125;;<br>        <span class="hljs-keyword">if</span> (isModule) &#123;<br>            <span class="hljs-keyword">if</span> (!promise) &#123;<br>                <span class="hljs-comment">// <span class="hljs-doctag">FIXME:</span> This should use an absolute file URL https://bugs.webkit.org/show_bug.cgi?id=193077</span><br>                promise = <span class="hljs-built_in">loadAndEvaluateModule</span>(globalObject, <span class="hljs-built_in">jscSource</span>(<span class="hljs-built_in">stringFromUTF</span>(scriptBuffer), sourceOrigin, fileName, <span class="hljs-built_in">TextPosition</span>(), SourceProviderSourceType::Module), <span class="hljs-built_in">jsUndefined</span>());<br>                <span class="hljs-built_in">RETURN_IF_EXCEPTION</span>(scope, <span class="hljs-built_in">void</span>());<br>            &#125;<br><br>            JSFunction* fulfillHandler = JSNativeStdFunction::<span class="hljs-built_in">create</span>(vm, globalObject, <span class="hljs-number">1</span>, <span class="hljs-built_in">String</span>(), [&amp;success, &amp;options, isLastFile](JSGlobalObject* globalObject, CallFrame* callFrame) &#123;<br>                <span class="hljs-built_in">checkException</span>(<span class="hljs-built_in">jsCast</span>&lt;GlobalObject*&gt;(globalObject), isLastFile, <span class="hljs-literal">false</span>, callFrame-&gt;<span class="hljs-built_in">argument</span>(<span class="hljs-number">0</span>), options, success);<br>                <span class="hljs-keyword">return</span> JSValue::<span class="hljs-built_in">encode</span>(<span class="hljs-built_in">jsUndefined</span>());<br>            &#125;);<br><br>            JSFunction* rejectHandler = JSNativeStdFunction::<span class="hljs-built_in">create</span>(vm, globalObject, <span class="hljs-number">1</span>, <span class="hljs-built_in">String</span>(), [&amp;success, &amp;options, isLastFile](JSGlobalObject* globalObject, CallFrame* callFrame) &#123;<br>                <span class="hljs-built_in">checkException</span>(<span class="hljs-built_in">jsCast</span>&lt;GlobalObject*&gt;(globalObject), isLastFile, <span class="hljs-literal">true</span>, callFrame-&gt;<span class="hljs-built_in">argument</span>(<span class="hljs-number">0</span>), options, success);<br>                <span class="hljs-keyword">return</span> JSValue::<span class="hljs-built_in">encode</span>(<span class="hljs-built_in">jsUndefined</span>());<br>            &#125;);<br><br>            promise-&gt;<span class="hljs-built_in">then</span>(globalObject, fulfillHandler, rejectHandler);<br>            scope.<span class="hljs-built_in">releaseAssertNoExceptionExceptTermination</span>();<br>            vm.<span class="hljs-built_in">drainMicrotasks</span>();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            NakedPtr&lt;Exception&gt; evaluationException;<br>            JSValue returnValue = <span class="hljs-built_in">evaluate</span>(globalObject, <span class="hljs-built_in">jscSource</span>(scriptBuffer, sourceOrigin , fileName), <span class="hljs-built_in">JSValue</span>(), evaluationException);<br>            scope.<span class="hljs-built_in">assertNoException</span>();<br>            <span class="hljs-keyword">if</span> (evaluationException)<br>                returnValue = evaluationException-&gt;<span class="hljs-built_in">value</span>();<br>            <span class="hljs-built_in">checkException</span>(globalObject, isLastFile, evaluationException, returnValue, options, success);<br>        &#125;<br><br>        scriptBuffer.<span class="hljs-built_in">clear</span>();<br>        scope.<span class="hljs-built_in">clearException</span>();<br>    &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> ENABLE(REGEXP_TRACING)</span><br>    vm.<span class="hljs-built_in">dumpRegExpTrace</span>();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>总结一下大致的运行逻辑，由<code>main</code>到<code>jscmain</code>，然后调用<code>runJSC</code>函数，在<code>runJSC</code>函数中通过<code>do while</code>来循环调用<code>runWithOptions</code>函数并且负责将执行后的<code>status</code>传回到<code>Fuzzilli</code>，最后是<code>runWithOptions</code>函数负责从共享内存中读取数据到代码缓冲区，然后来运行。</p>
<h2 id="Fuzzilli中"><a href="#Fuzzilli中" class="headerlink" title="Fuzzilli中"></a>Fuzzilli中</h2><p>下面介绍的主要是围绕<code>libreprl</code>部分，因为这部分主要与<code>JSC</code>那边进行底层通信</p>
<h3 id="initialize"><a href="#initialize" class="headerlink" title="initialize"></a>initialize</h3><p>这个能追溯到<code>Fuzzer</code>初始化，最后在<code>REPRL</code>的<code>initialize</code>函数中：</p>
<p>调用了：</p>
<p><code>reprl_create_context</code></p>
<p><code>reprl_initialize_context</code></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">initialize</span>() &#123;<br>    reprlContext <span class="hljs-operator">=</span> libreprl.reprl_create_context()<br>    <span class="hljs-keyword">if</span> reprlContext <span class="hljs-operator">==</span> <span class="hljs-literal">nil</span> &#123;<br>        logger.fatal(<span class="hljs-string">&quot;Failed to create REPRL context&quot;</span>)<br>    &#125;<br><br>    <span class="hljs-keyword">let</span> argv <span class="hljs-operator">=</span> convertToCArray(processArguments)<br>    <span class="hljs-keyword">let</span> envp <span class="hljs-operator">=</span> convertToCArray(env)<br><br>    <span class="hljs-keyword">if</span> reprl_initialize_context(reprlContext, argv, envp, <span class="hljs-comment">/* capture stdout */</span> <span class="hljs-number">1</span>, <span class="hljs-comment">/* capture stderr: */</span> <span class="hljs-number">1</span>) <span class="hljs-operator">!=</span> <span class="hljs-number">0</span> &#123;<br>        logger.fatal(<span class="hljs-string">&quot;Failed to initialize REPRL context: <span class="hljs-subst">\(String(cString: reprl_get_last_error(reprlContext)))</span>&quot;</span>)<br>    &#125;<br><br>    freeCArray(argv, numElems: processArguments.count)<br>    freeCArray(envp, numElems: env.count)<br><br>    fuzzer.registerEventListener(for: fuzzer.events.<span class="hljs-type">Shutdown</span>) &#123; <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span><br>        reprl_destroy_context(<span class="hljs-keyword">self</span>.reprlContext)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="reprl-create-context"><a href="#reprl-create-context" class="headerlink" title="reprl_create_context"></a>reprl_create_context</h4><p>下面主要注意下<code>dup2</code>函数：</p>
<blockquote>
<p>&#x2F;&#x2F; 该函数的作用是复制一个现有的文件描述符，并将其覆盖到另一个文件描述符上，使它们指向同一个文件。</p>
<p>int dup2(int oldfd, int newfd);</p>
</blockquote>
<p>所以下面<code>reprl_create_context</code>函数中是将预留的文件描述符暂时指向<code>/dev/null</code></p>
<blockquote>
<p>REPRL_CHILD_CTRL_IN 可以理解为控制通道，这个是入口</p>
<p>REPRL_CHILD_CTRL_OUT 这个是出口</p>
<p>REPRL_CHILD_DATA_IN 可以理解为数据通道，这个是入口</p>
<p>REPRL_CHILD_DATA_OUT 这个是出口</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">// Well-known file descriptor numbers for reprl &lt;-&gt; child communication, child</span><br><span class="hljs-comment">// process side</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> REPRL_CHILD_CTRL_IN 100</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> REPRL_CHILD_CTRL_OUT 101</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> REPRL_CHILD_DATA_IN 102</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> REPRL_CHILD_DATA_OUT 103</span><br><span class="hljs-comment">// A unidirectional communication channel for larger amounts of data, up to a maximum size (REPRL_MAX_DATA_SIZE).</span><br><span class="hljs-comment">// Implemented as a (RAM-backed) file for which the file descriptor is shared with the child process and which is mapped into our address space.</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">data_channel</span> &#123;</span><br>    <span class="hljs-comment">// File descriptor of the underlying file. Directly shared with the child process.</span><br>    <span class="hljs-type">int</span> fd;<br>    <span class="hljs-comment">// Memory mapping of the file, always of size REPRL_MAX_DATA_SIZE.</span><br>    <span class="hljs-type">char</span>* mapping;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">reprl_context</span> &#123;</span><br>    <span class="hljs-comment">// Whether reprl_initialize has been successfully performed on this context.</span><br>    <span class="hljs-type">int</span> initialized;<br><br>    <span class="hljs-comment">// Read file descriptor of the control pipe. Only valid if a child process is running (i.e. pid is nonzero).</span><br>    <span class="hljs-type">int</span> ctrl_in;<br>    <span class="hljs-comment">// Write file descriptor of the control pipe. Only valid if a child process is running (i.e. pid is nonzero).</span><br>    <span class="hljs-type">int</span> ctrl_out;<br><br>    <span class="hljs-comment">// Data channel REPRL -&gt; Child</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">data_channel</span>* <span class="hljs-title">data_in</span>;</span><br>    <span class="hljs-comment">// Data channel Child -&gt; REPRL</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">data_channel</span>* <span class="hljs-title">data_out</span>;</span><br>    <br>    <span class="hljs-comment">// Optional data channel for the child&#x27;s stdout and stderr.</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">data_channel</span>* <span class="hljs-title">child_stdout</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">data_channel</span>* <span class="hljs-title">child_stderr</span>;</span><br>    <br>    <span class="hljs-comment">// PID of the child process. Will be zero if no child process is currently running.</span><br>    <span class="hljs-type">pid_t</span> pid;<br><br>    <span class="hljs-comment">// Arguments and environment for the child process.</span><br>    <span class="hljs-type">char</span>** argv;<br>    <span class="hljs-type">char</span>** envp;<br>    <br>    <span class="hljs-comment">// A malloc&#x27;d string containing a description of the last error that occurred.</span><br>    <span class="hljs-type">char</span>* last_error;<br>&#125;;<br><br><span class="hljs-keyword">struct</span> reprl_context* <span class="hljs-title function_">reprl_create_context</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-comment">// &quot;Reserve&quot; the well-known REPRL fds so no other fd collides with them.</span><br>    <span class="hljs-comment">// This would cause various kinds of issues in reprl_spawn_child.</span><br>    <span class="hljs-comment">// It would be enough to do this once per process in the case of multiple</span><br>    <span class="hljs-comment">// REPRL instances, but it&#x27;s probably not worth the implementation effort.</span><br>    <span class="hljs-type">int</span> devnull = open(<span class="hljs-string">&quot;/dev/null&quot;</span>, O_RDWR);<br>    dup2(devnull, REPRL_CHILD_CTRL_IN);<br>    dup2(devnull, REPRL_CHILD_CTRL_OUT);<br>    dup2(devnull, REPRL_CHILD_DATA_IN);<br>    dup2(devnull, REPRL_CHILD_DATA_OUT);<br>    close(devnull);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> reprl_context));<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="reprl-initialize-context"><a href="#reprl-initialize-context" class="headerlink" title="reprl_initialize_context"></a>reprl_initialize_context</h4><p>主要内容是对上下文结构体进行初始化，下面主要关注<code>reprl_create_data_channel</code>函数：</p>
<p><code>ctx -&gt; data_in</code>和<code>ctx -&gt; data_out</code>分别创建了一个<code>data_channel</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">int</span> <span class="hljs-title function_">reprl_initialize_context</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> reprl_context* ctx, <span class="hljs-type">const</span> <span class="hljs-type">char</span>** argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span>** envp, <span class="hljs-type">int</span> capture_stdout, <span class="hljs-type">int</span> capture_stderr)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (ctx-&gt;initialized) &#123;<br>        <span class="hljs-keyword">return</span> reprl_error(ctx, <span class="hljs-string">&quot;Context is already initialized&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-comment">// We need to ignore SIGPIPE since we could end up writing to a pipe after our child process has exited.</span><br>    signal(SIGPIPE, SIG_IGN);<br><br>    ctx-&gt;argv = copy_string_array(argv);<br>    ctx-&gt;envp = copy_string_array(envp);<br>    <br>    ctx-&gt;data_in = reprl_create_data_channel(ctx);<br>    ctx-&gt;data_out = reprl_create_data_channel(ctx);<br>    <span class="hljs-keyword">if</span> (capture_stdout) &#123;<br>        ctx-&gt;child_stdout = reprl_create_data_channel(ctx);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (capture_stderr) &#123;<br>        ctx-&gt;child_stderr = reprl_create_data_channel(ctx);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!ctx-&gt;data_in || !ctx-&gt;data_out || (capture_stdout &amp;&amp; !ctx-&gt;child_stdout) || (capture_stderr &amp;&amp; !ctx-&gt;child_stderr)) &#123;<br>        <span class="hljs-comment">// Proper error message will have been set by reprl_create_data_channel</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <br>    ctx-&gt;initialized = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="reprl-create-data-channel"><a href="#reprl-create-data-channel" class="headerlink" title="reprl_create_data_channel"></a>reprl_create_data_channel</h4><p> <code>memfd_create()</code> 在内核中创建一个匿名内存文件，并返回一个指向该文件的文件描述符，并不会落地一个文件。</p>
<p> <code>mktemp()</code> 创建一个临时文件，是有文件名的；配合<code>unlink</code>可以删除文件在目录中的目录项，即删除文件名与文件inode的关联，但并不会关闭与该文件关联的文件描述符。</p>
<p>所以下面总体功能就是创建一个临时文件并得到文件描述符<code>fd</code>，并且将此文件映射到此进程即<code>mapping</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> data_channel* <span class="hljs-title function_">reprl_create_data_channel</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> reprl_context* ctx)</span><br>&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> __linux__</span><br>    <span class="hljs-type">int</span> fd = memfd_create(<span class="hljs-string">&quot;REPRL_DATA_CHANNEL&quot;</span>, MFD_CLOEXEC);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    <span class="hljs-type">char</span> path[] = <span class="hljs-string">&quot;/tmp/reprl_data_channel_XXXXXXXX&quot;</span>;<br>    <span class="hljs-keyword">if</span> (mktemp(path) &lt; <span class="hljs-number">0</span>) &#123;<br>        reprl_error(ctx, <span class="hljs-string">&quot;Failed to create temporary filename for data channel: %s&quot;</span>, strerror(errno));<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>    <span class="hljs-type">int</span> fd = open(path, O_RDWR | O_CREAT| O_CLOEXEC);<br>    unlink(path);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-keyword">if</span> (fd == <span class="hljs-number">-1</span> || ftruncate(fd, REPRL_MAX_DATA_SIZE) != <span class="hljs-number">0</span>) &#123;<br>        reprl_error(ctx, <span class="hljs-string">&quot;Failed to create data channel file: %s&quot;</span>, strerror(errno));<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>    <span class="hljs-type">char</span>* mapping = mmap(<span class="hljs-number">0</span>, REPRL_MAX_DATA_SIZE, PROT_READ | PROT_WRITE, MAP_SHARED, fd, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (mapping == MAP_FAILED) &#123;<br>        reprl_error(ctx, <span class="hljs-string">&quot;Failed to mmap data channel file: %s&quot;</span>, strerror(errno));<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>    <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">data_channel</span>* <span class="hljs-title">channel</span> =</span> <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> data_channel));<br>    channel-&gt;fd = fd;<br>    channel-&gt;mapping = mapping;<br>    <span class="hljs-keyword">return</span> channel;<br>&#125;<br></code></pre></td></tr></table></figure>





<h3 id="reprl-execute"><a href="#reprl-execute" class="headerlink" title="reprl_execute"></a>reprl_execute</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">int</span> <span class="hljs-title function_">reprl_execute</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> reprl_context* ctx, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* script, <span class="hljs-type">uint64_t</span> script_length, <span class="hljs-type">uint64_t</span> timeout, <span class="hljs-type">uint64_t</span>* execution_time, <span class="hljs-type">int</span> fresh_instance)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (!ctx-&gt;initialized) &#123;<br>        <span class="hljs-keyword">return</span> reprl_error(ctx, <span class="hljs-string">&quot;REPRL context is not initialized&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (script_length &gt; REPRL_MAX_DATA_SIZE) &#123;<br>        <span class="hljs-keyword">return</span> reprl_error(ctx, <span class="hljs-string">&quot;Script too large&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// Terminate any existing instance if requested.</span><br>    <span class="hljs-keyword">if</span> (fresh_instance &amp;&amp; ctx-&gt;pid) &#123;<br>        reprl_terminate_child(ctx);<br>    &#125;<br><br>    <span class="hljs-comment">// Reset file position so the child can simply read(2) and write(2) to these fds.</span><br>    lseek(ctx-&gt;data_out-&gt;fd, <span class="hljs-number">0</span>, SEEK_SET);<br>    lseek(ctx-&gt;data_in-&gt;fd, <span class="hljs-number">0</span>, SEEK_SET);<br>    <span class="hljs-keyword">if</span> (ctx-&gt;child_stdout) &#123;<br>        lseek(ctx-&gt;child_stdout-&gt;fd, <span class="hljs-number">0</span>, SEEK_SET);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (ctx-&gt;child_stderr) &#123;<br>        lseek(ctx-&gt;child_stderr-&gt;fd, <span class="hljs-number">0</span>, SEEK_SET);<br>    &#125;<br>    <br>    <span class="hljs-comment">// Spawn a new instance if necessary.</span><br>    <span class="hljs-keyword">if</span> (!ctx-&gt;pid) &#123;<br>        <span class="hljs-type">int</span> r = reprl_spawn_child(ctx);<br>        <span class="hljs-keyword">if</span> (r != <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> r;<br>    &#125;<br><br>    <span class="hljs-comment">// Copy the script to the data channel.</span><br>    <span class="hljs-built_in">memcpy</span>(ctx-&gt;data_out-&gt;mapping, script, script_length);<br><br>    <span class="hljs-comment">// Tell child to execute the script.</span><br>    <span class="hljs-keyword">if</span> (write(ctx-&gt;ctrl_out, <span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-number">4</span>) != <span class="hljs-number">4</span> ||<br>        write(ctx-&gt;ctrl_out, &amp;script_length, <span class="hljs-number">8</span>) != <span class="hljs-number">8</span>) &#123;<br>        <span class="hljs-comment">// These can fail if the child unexpectedly terminated between executions.</span><br>        <span class="hljs-comment">// Check for that here to be able to provide a better error message.</span><br>        <span class="hljs-type">int</span> status;<br>        <span class="hljs-keyword">if</span> (waitpid(ctx-&gt;pid, &amp;status, WNOHANG) == ctx-&gt;pid) &#123;<br>            reprl_child_terminated(ctx);<br>            <span class="hljs-keyword">if</span> (WIFEXITED(status)) &#123;<br>                <span class="hljs-keyword">return</span> reprl_error(ctx, <span class="hljs-string">&quot;Child unexpectedly exited with status %i between executions&quot;</span>, WEXITSTATUS(status));<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">return</span> reprl_error(ctx, <span class="hljs-string">&quot;Child unexpectedly terminated with signal %i between executions&quot;</span>, WTERMSIG(status));<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> reprl_error(ctx, <span class="hljs-string">&quot;Failed to send command to child process: %s&quot;</span>, strerror(errno));<br>    &#125;<br><br>    <span class="hljs-comment">// Wait for child to finish execution (or crash).</span><br>    <span class="hljs-type">int</span> timeout_ms = timeout / <span class="hljs-number">1000</span>;<br>    <span class="hljs-type">uint64_t</span> start_time = current_usecs();<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">fds</span> =</span> &#123;.fd = ctx-&gt;ctrl_in, .events = POLLIN, .revents = <span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-type">int</span> res = poll(&amp;fds, <span class="hljs-number">1</span>, timeout_ms);<br>    *execution_time = current_usecs() - start_time;<br>    <span class="hljs-keyword">if</span> (res == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// Execution timed out. Kill child and return a timeout status.</span><br>        reprl_terminate_child(ctx);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">16</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (res != <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-comment">// An error occurred.</span><br>        <span class="hljs-comment">// We expect all signal handlers to be installed with SA_RESTART, so receiving EINTR here is unexpected and thus also an error.</span><br>        <span class="hljs-keyword">return</span> reprl_error(ctx, <span class="hljs-string">&quot;Failed to poll: %s&quot;</span>, strerror(errno));<br>    &#125;<br>    <br>    <span class="hljs-comment">// Poll succeeded, so there must be something to read now (either the status or EOF).</span><br>    <span class="hljs-type">int</span> status;<br>    <span class="hljs-type">ssize_t</span> rv = read(ctx-&gt;ctrl_in, &amp;status, <span class="hljs-number">4</span>);<br>    <span class="hljs-keyword">if</span> (rv &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> reprl_error(ctx, <span class="hljs-string">&quot;Failed to read from control pipe: %s&quot;</span>, strerror(errno));<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rv != <span class="hljs-number">4</span>) &#123;<br>        <span class="hljs-comment">// Most likely, the child process crashed and closed the write end of the control pipe.</span><br>        <span class="hljs-comment">// Unfortunately, there probably is nothing that guarantees that waitpid() will immediately succeed now,</span><br>        <span class="hljs-comment">// and we also don&#x27;t want to block here. So just retry waitpid() a few times...</span><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;libreprl-line419-for testing asan check\n&quot;</span>);<br>        <span class="hljs-type">int</span> success = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">do</span> &#123;<br>            success = waitpid(ctx-&gt;pid, &amp;status, WNOHANG) == ctx-&gt;pid;<br>            <span class="hljs-keyword">if</span> (!success) usleep(<span class="hljs-number">10</span>);<br>        &#125; <span class="hljs-keyword">while</span> (!success &amp;&amp; current_usecs() - start_time &lt; timeout);<br>        <br>        <span class="hljs-keyword">if</span> (!success) &#123;<br>            <span class="hljs-comment">// Wait failed, so something weird must have happened. Maybe somehow the control pipe was closed without the child exiting?</span><br>            <span class="hljs-comment">// Probably the best we can do is kill the child and return an error.</span><br>            reprl_terminate_child(ctx);<br>            <span class="hljs-keyword">return</span> reprl_error(ctx, <span class="hljs-string">&quot;Child in weird state after execution&quot;</span>);<br>        &#125;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;libreprl-line432-for testing status value: %d\n&quot;</span>, status);<br>        <span class="hljs-comment">// Cleanup any state related to this child process.</span><br>        reprl_child_terminated(ctx);<br><br>        <span class="hljs-keyword">if</span> (WIFEXITED(status)) &#123;<br>            status = WEXITSTATUS(status) &lt;&lt; <span class="hljs-number">8</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (WIFSIGNALED(status)) &#123;<br>            status = WTERMSIG(status);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// This shouldn&#x27;t happen, since we don&#x27;t specify WUNTRACED for waitpid...</span><br>            <span class="hljs-keyword">return</span> reprl_error(ctx, <span class="hljs-string">&quot;Waitpid returned unexpected child state %i&quot;</span>, status);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">// The status must be a positive number, see the status encoding format below.</span><br>    <span class="hljs-comment">// We also don&#x27;t allow the child process to indicate a timeout. If we wanted,</span><br>    <span class="hljs-comment">// we could treat it as an error if the upper bits are set.</span><br>    <span class="hljs-comment">//jy add</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;libreprl-djy-status:%d\n&quot;</span>, status);<br>    <br>    status &amp;= <span class="hljs-number">0xffff</span>;<br><br>    <span class="hljs-keyword">return</span> status;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="reprl-spawn-child"><a href="#reprl-spawn-child" class="headerlink" title="reprl_spawn_child"></a>reprl_spawn_child</h4><p>使用<code>ftruncate</code>来设置文件的大小；</p>
<p><code>crpipe</code>和<code>cwpipe</code>是用来存储管道的两端，<code>[0]</code>存储<code>读管道描述符</code>，<code>[1]</code>存储<code>写管道描述符</code>；下面所提到的读写都是站在<code>Fuzzilli</code>的角度上看的，比如<code>crpipe</code>代表<code>reprl</code>从<code>child</code>中读，即数据流向是从<code>child</code>到<code>reprl</code>，所以我们只留取<code>[0]</code>，cwpipe是同理留取<code>[1]</code>。</p>
<blockquote>
<p>in代表数据进即读，out代表数据出即写</p>
<p>ctrx_in &#x3D; crpipe[0]</p>
<p>ctx_out &#x3D; cwpipe[1]</p>
</blockquote>
<p><code>fcntl</code>用来设置如果该进程调用了exec族函数时会自动关闭这些文件描述符，防止资源泄露。</p>
<p>接着利用<code>dup2</code>：</p>
<blockquote>
<p>对应关系以及数据流向：</p>
<p>REPRL_CHILD_CTRL_IN &#x3D; cwpipe[0]         &lt;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;  cwpipe[1] &#x3D; ctrl_out（Fuzzilli向JSC回传招呼和执行指令）</p>
<p>REPRL_CHILD_CTRL_OUT &#x3D; crpipe[1]       &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;  crpipe[0] &#x3D; ctrl_in（JSC向Fuzzilli回传招呼信息以及状态信息）</p>
<p>ctx-&gt;data_out-&gt;fd &#x3D;&#x3D;&#x3D;&gt;shared memory(file1)&#x3D;&#x3D;&#x3D;&gt; REPRL_CHILD_DATA_IN（用于传输script）</p>
<p>ctx-&gt;data_in-&gt;fd &lt;&#x3D;&#x3D;&#x3D;shared memory(file2)&lt;&#x3D;&#x3D;&#x3D; REPRL_CHILD_DATA_OUT（用于传输JSC中的fuzz结果）</p>
</blockquote>
<p>在子进程中还会关闭<code>crpipe[1]</code>和<code>cwpipe[0]</code>，因为描述符已经通过<code>dup2</code>被接管了。接着关闭没用的文件描述符，最后子进程启动jsShell。</p>
<p>在父进程中也会关闭<code>crpipe[1]</code>和<code>cwpipe[0]</code>，因为父进程用不到。接着就在父进程中进行读取打招呼的信息，然后再回一个招呼，由于上面创建的管道并没有设置无堵塞模式，所以这里<code>read</code>没读取到内容会进行堵塞直到有信息。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">reprl_spawn_child</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> reprl_context* ctx)</span><br>&#123;<br>    <span class="hljs-comment">// This is also a good time to ensure the data channel backing files don&#x27;t grow too large.</span><br>    ftruncate(ctx-&gt;data_in-&gt;fd, REPRL_MAX_DATA_SIZE);<br>    ftruncate(ctx-&gt;data_out-&gt;fd, REPRL_MAX_DATA_SIZE);<br>    <span class="hljs-keyword">if</span> (ctx-&gt;child_stdout) ftruncate(ctx-&gt;child_stdout-&gt;fd, REPRL_MAX_DATA_SIZE);<br>    <span class="hljs-keyword">if</span> (ctx-&gt;child_stderr) ftruncate(ctx-&gt;child_stderr-&gt;fd, REPRL_MAX_DATA_SIZE);<br>    <br>    <span class="hljs-type">int</span> crpipe[<span class="hljs-number">2</span>] = &#123; <span class="hljs-number">0</span>, <span class="hljs-number">0</span> &#125;;          <span class="hljs-comment">// control pipe child -&gt; reprl</span><br>    <span class="hljs-type">int</span> cwpipe[<span class="hljs-number">2</span>] = &#123; <span class="hljs-number">0</span>, <span class="hljs-number">0</span> &#125;;          <span class="hljs-comment">// control pipe reprl -&gt; child</span><br><br>    <span class="hljs-keyword">if</span> (pipe(crpipe) != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> reprl_error(ctx, <span class="hljs-string">&quot;Could not create pipe for REPRL communication: %s&quot;</span>, strerror(errno));<br>    &#125;<br>    <span class="hljs-keyword">if</span> (pipe(cwpipe) != <span class="hljs-number">0</span>) &#123;<br>        close(crpipe[<span class="hljs-number">0</span>]);<br>        close(crpipe[<span class="hljs-number">1</span>]);<br>        <span class="hljs-keyword">return</span> reprl_error(ctx, <span class="hljs-string">&quot;Could not create pipe for REPRL communication: %s&quot;</span>, strerror(errno));<br>    &#125;<br><br>    ctx-&gt;ctrl_in = crpipe[<span class="hljs-number">0</span>];<br>    ctx-&gt;ctrl_out = cwpipe[<span class="hljs-number">1</span>];<br>    fcntl(ctx-&gt;ctrl_in, F_SETFD, FD_CLOEXEC);<br>    fcntl(ctx-&gt;ctrl_out, F_SETFD, FD_CLOEXEC);<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> __linux__</span><br>    <span class="hljs-comment">// Use vfork() on Linux as that considerably improves the fuzzer performance. See also https://github.com/googleprojectzero/fuzzilli/issues/174</span><br>    <span class="hljs-comment">// Due to vfork, the code executed in the child process *must not* modify any memory apart from its stack, as it will share the page table of its parent.</span><br>    <span class="hljs-type">pid_t</span> pid = vfork();<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    <span class="hljs-type">pid_t</span> pid = fork();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">if</span> (dup2(cwpipe[<span class="hljs-number">0</span>], REPRL_CHILD_CTRL_IN) &lt; <span class="hljs-number">0</span> ||<br>            dup2(crpipe[<span class="hljs-number">1</span>], REPRL_CHILD_CTRL_OUT) &lt; <span class="hljs-number">0</span> ||<br>            dup2(ctx-&gt;data_out-&gt;fd, REPRL_CHILD_DATA_IN) &lt; <span class="hljs-number">0</span> ||<br>            dup2(ctx-&gt;data_in-&gt;fd, REPRL_CHILD_DATA_OUT) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;dup2 failed in the child: %s\n&quot;</span>, strerror(errno));<br>            _exit(<span class="hljs-number">-1</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// Unblock any blocked signals. It seems that libdispatch sometimes blocks delivery of certain signals.</span><br>        <span class="hljs-type">sigset_t</span> newset;<br>        sigemptyset(&amp;newset);<br>        <span class="hljs-keyword">if</span> (sigprocmask(SIG_SETMASK, &amp;newset, <span class="hljs-literal">NULL</span>) != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;sigprocmask failed in the child: %s\n&quot;</span>, strerror(errno));<br>            _exit(<span class="hljs-number">-1</span>);<br>        &#125;<br><br>        close(cwpipe[<span class="hljs-number">0</span>]);<br>        close(crpipe[<span class="hljs-number">1</span>]);<br><br>        <span class="hljs-type">int</span> devnull = open(<span class="hljs-string">&quot;/dev/null&quot;</span>, O_RDWR);<br>        dup2(devnull, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (ctx-&gt;child_stdout) dup2(ctx-&gt;child_stdout-&gt;fd, <span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">else</span> dup2(devnull, <span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">if</span> (ctx-&gt;child_stderr) dup2(ctx-&gt;child_stderr-&gt;fd, <span class="hljs-number">2</span>);<br>        <span class="hljs-keyword">else</span> dup2(devnull, <span class="hljs-number">2</span>);<br>        close(devnull);<br>        <br>        <span class="hljs-comment">// close all other FDs. We try to use FD_CLOEXEC everywhere, but let&#x27;s be extra sure we don&#x27;t leak any fds to the child.</span><br>        <span class="hljs-type">int</span> tablesize = getdtablesize();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">3</span>; i &lt; tablesize; i++) &#123;<br>            <span class="hljs-keyword">if</span> (i == REPRL_CHILD_CTRL_IN || i == REPRL_CHILD_CTRL_OUT || i == REPRL_CHILD_DATA_IN || i == REPRL_CHILD_DATA_OUT) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            close(i);<br>        &#125;<br><br>        execve(ctx-&gt;argv[<span class="hljs-number">0</span>], ctx-&gt;argv, ctx-&gt;envp);<br>        <br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Failed to execute child process %s: %s\n&quot;</span>, ctx-&gt;argv[<span class="hljs-number">0</span>], strerror(errno));<br>        fflush(<span class="hljs-built_in">stderr</span>);<br>        _exit(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <br>    close(crpipe[<span class="hljs-number">1</span>]);<br>    close(cwpipe[<span class="hljs-number">0</span>]);<br>    <br>    <span class="hljs-keyword">if</span> (pid &lt; <span class="hljs-number">0</span>) &#123;<br>        close(ctx-&gt;ctrl_in);<br>        close(ctx-&gt;ctrl_out);<br>        <span class="hljs-keyword">return</span> reprl_error(ctx, <span class="hljs-string">&quot;Failed to fork: %s&quot;</span>, strerror(errno));<br>    &#125;<br>    ctx-&gt;pid = pid;<br><br>    <span class="hljs-type">char</span> helo[<span class="hljs-number">5</span>] = &#123; <span class="hljs-number">0</span> &#125;;<br>    <span class="hljs-keyword">if</span> (read(ctx-&gt;ctrl_in, helo, <span class="hljs-number">4</span>) != <span class="hljs-number">4</span>) &#123;<br>        reprl_terminate_child(ctx);<br>        <span class="hljs-keyword">return</span> reprl_error(ctx, <span class="hljs-string">&quot;Did not receive HELO message from child: %s&quot;</span>, strerror(errno));<br>    &#125;<br>    <br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(helo, <span class="hljs-string">&quot;HELO&quot;</span>, <span class="hljs-number">4</span>) != <span class="hljs-number">0</span>) &#123;<br>        reprl_terminate_child(ctx);<br>        <span class="hljs-keyword">return</span> reprl_error(ctx, <span class="hljs-string">&quot;Received invalid HELO message from child: %s&quot;</span>, helo);<br>    &#125;<br>    <br>    <span class="hljs-keyword">if</span> (write(ctx-&gt;ctrl_out, helo, <span class="hljs-number">4</span>) != <span class="hljs-number">4</span>) &#123;<br>        reprl_terminate_child(ctx);<br>        <span class="hljs-keyword">return</span> reprl_error(ctx, <span class="hljs-string">&quot;Failed to send HELO reply message to child: %s&quot;</span>, strerror(errno));<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="script执行"><a href="#script执行" class="headerlink" title="script执行"></a>script执行</h4><p>先将脚本拷贝到共享内存区域，然后发送<code>exec</code>和<code>script_length</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">// Copy the script to the data channel.</span><br>    <span class="hljs-built_in">memcpy</span>(ctx-&gt;data_out-&gt;mapping, script, script_length);<br><br>    <span class="hljs-comment">// Tell child to execute the script.</span><br>    <span class="hljs-keyword">if</span> (write(ctx-&gt;ctrl_out, <span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-number">4</span>) != <span class="hljs-number">4</span> ||<br>        write(ctx-&gt;ctrl_out, &amp;script_length, <span class="hljs-number">8</span>) != <span class="hljs-number">8</span>) &#123;<br>        <span class="hljs-comment">// These can fail if the child unexpectedly terminated between executions.</span><br>        <span class="hljs-comment">// Check for that here to be able to provide a better error message.</span><br>        <span class="hljs-type">int</span> status;<br>        <span class="hljs-keyword">if</span> (waitpid(ctx-&gt;pid, &amp;status, WNOHANG) == ctx-&gt;pid) &#123;<br>            reprl_child_terminated(ctx);<br>            <span class="hljs-keyword">if</span> (WIFEXITED(status)) &#123;<br>                <span class="hljs-keyword">return</span> reprl_error(ctx, <span class="hljs-string">&quot;Child unexpectedly exited with status %i between executions&quot;</span>, WEXITSTATUS(status));<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">return</span> reprl_error(ctx, <span class="hljs-string">&quot;Child unexpectedly terminated with signal %i between executions&quot;</span>, WTERMSIG(status));<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> reprl_error(ctx, <span class="hljs-string">&quot;Failed to send command to child process: %s&quot;</span>, strerror(errno));<br>    &#125;<br><br>    <span class="hljs-comment">// Wait for child to finish execution (or crash).</span><br>    <span class="hljs-type">int</span> timeout_ms = timeout / <span class="hljs-number">1000</span>;<br>    <span class="hljs-type">uint64_t</span> start_time = current_usecs();<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">fds</span> =</span> &#123;.fd = ctx-&gt;ctrl_in, .events = POLLIN, .revents = <span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-type">int</span> res = poll(&amp;fds, <span class="hljs-number">1</span>, timeout_ms);<br>    *execution_time = current_usecs() - start_time;<br>    <span class="hljs-keyword">if</span> (res == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// Execution timed out. Kill child and return a timeout status.</span><br>        reprl_terminate_child(ctx);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">16</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (res != <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-comment">// An error occurred.</span><br>        <span class="hljs-comment">// We expect all signal handlers to be installed with SA_RESTART, so receiving EINTR here is unexpected and thus also an error.</span><br>        <span class="hljs-keyword">return</span> reprl_error(ctx, <span class="hljs-string">&quot;Failed to poll: %s&quot;</span>, strerror(errno));<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>利用<code>poll</code>来监控<code>ctrl_in</code>的<code>POLLIN</code>事件发生，下面是<code>POLLIN</code>事件发生，首先尝试从控制管道中进行读取状态信息：</p>
<p><code>rv &lt; 0</code>是<code>read</code>出错，<code>rv != 4</code>说明子进程中出现了<code>crash</code>而导致关闭了控制管道，因为文件描述符正常是堵塞模式，如果能正常读信息就是读取子进程传过来的状态，如果子进程没有发送状态，<code>read</code>会一直堵塞，如果子进程终止了执行同时也会终止管道符，然后紧接着读取子进程的状态信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">// Poll succeeded, so there must be something to read now (either the status or EOF).</span><br><span class="hljs-type">int</span> status;<br><span class="hljs-type">ssize_t</span> rv = read(ctx-&gt;ctrl_in, &amp;status, <span class="hljs-number">4</span>);<br><span class="hljs-keyword">if</span> (rv &lt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">return</span> reprl_error(ctx, <span class="hljs-string">&quot;Failed to read from control pipe: %s&quot;</span>, strerror(errno));<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rv != <span class="hljs-number">4</span>) &#123;<br>    <span class="hljs-comment">// Most likely, the child process crashed and closed the write end of the control pipe.</span><br>    <span class="hljs-comment">// Unfortunately, there probably is nothing that guarantees that waitpid() will immediately succeed now,</span><br>    <span class="hljs-comment">// and we also don&#x27;t want to block here. So just retry waitpid() a few times...</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;libreprl-line419-for testing asan check\n&quot;</span>);<br>    <span class="hljs-type">int</span> success = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">do</span> &#123;<br>        success = waitpid(ctx-&gt;pid, &amp;status, WNOHANG) == ctx-&gt;pid;<br>        <span class="hljs-keyword">if</span> (!success) usleep(<span class="hljs-number">10</span>);<br>    &#125; <span class="hljs-keyword">while</span> (!success &amp;&amp; current_usecs() - start_time &lt; timeout);<br>    <br>    <span class="hljs-keyword">if</span> (!success) &#123;<br>        <span class="hljs-comment">// Wait failed, so something weird must have happened. Maybe somehow the control pipe was closed without the child exiting?</span><br>        <span class="hljs-comment">// Probably the best we can do is kill the child and return an error.</span><br>        reprl_terminate_child(ctx);<br>        <span class="hljs-keyword">return</span> reprl_error(ctx, <span class="hljs-string">&quot;Child in weird state after execution&quot;</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;libreprl-line432-for testing status value: %d\n&quot;</span>, status);<br>    <span class="hljs-comment">// Cleanup any state related to this child process.</span><br>    reprl_child_terminated(ctx);<br><br>    <span class="hljs-keyword">if</span> (WIFEXITED(status)) &#123;<br>        status = WEXITSTATUS(status) &lt;&lt; <span class="hljs-number">8</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (WIFSIGNALED(status)) &#123;<br>        status = WTERMSIG(status);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// This shouldn&#x27;t happen, since we don&#x27;t specify WUNTRACED for waitpid...</span><br>        <span class="hljs-keyword">return</span> reprl_error(ctx, <span class="hljs-string">&quot;Waitpid returned unexpected child state %i&quot;</span>, status);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="二者交互的相关描述符"><a href="#二者交互的相关描述符" class="headerlink" title="二者交互的相关描述符"></a>二者交互的相关描述符</h2><blockquote>
<p>JSC使用控制管道时，使用的文件描述符名为REPRL_CHILD_CTRL_对应的REPRL_C*FD这种格式；</p>
<p>Fuzzilli中使用控制管道时使用ctrl_这种格式来向管道读写数据</p>
<p>下面两个是以管道的形式：（数据只能单向流动）</p>
<p>REPRL_CHILD_CTRL_IN（REPRL_CRFD） &#x3D; cwpipe[0]         &lt;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;  cwpipe[1] &#x3D; ctrl_out（Fuzzilli向JSC回传招呼和执行指令）</p>
<p>REPRL_CHILD_CTRL_OUT（REPRL_CWFD） &#x3D; crpipe[1]       &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;  crpipe[0] &#x3D; ctrl_in（JSC向Fuzzilli回传招呼信息以及状态信息）</p>
<p>JSC通过REPRL_DRFD将其映射到自己进程空间内，然后使用reprl_input_data来读取脚本内容；</p>
<p>Fuzzilli中通过使用ctx-&gt;data_-&gt;mapping的形式来向共享内存中写脚本内容</p>
<p>下面两个是共享内存的形式：（数据可以双向流动）</p>
<p>ctx-&gt;data_out-&gt;fd &#x3D;&#x3D;&#x3D;&gt;shared memory(file1)&#x3D;&#x3D;&#x3D;&gt; REPRL_CHILD_DATA_IN（用于传输script）</p>
<p>ctx-&gt;data_in-&gt;fd &lt;&#x3D;&#x3D;&#x3D;shared memory(file2)&lt;&#x3D;&#x3D;&#x3D; REPRL_CHILD_DATA_OUT（用于传输JSC中的fuzz测试结果，这个用在fuzzilli测试函数中，目前Fuzzilli没有读取这部分内容）</p>
</blockquote>
<p>下面是同一个描述符在两个项目中的叫法：</p>
<p><code>Fuzzilli</code>更倾向于用ctx-&gt;的形式操作管道或者共享内存，而<code>JSC</code>中是通过管道或者共享内存的文件描述符的宏定义来操作</p>
<table>
<thead>
<tr>
<th>Fuzzilli</th>
<th>fd</th>
<th>JSC</th>
</tr>
</thead>
<tbody><tr>
<td>REPRL_CHILD_CTRL_IN（管道）</td>
<td>100</td>
<td>REPRL_CRFD</td>
</tr>
<tr>
<td>REPRL_CHILD_CTRL_OUT（管道）</td>
<td>101</td>
<td>REPRL_CWFD</td>
</tr>
<tr>
<td>REPRL_CHILD_DATA_IN（共享内存）</td>
<td>102</td>
<td>REPRL_DRFD</td>
</tr>
<tr>
<td>REPRL_CHILD_DATA_OUT（共享内存）</td>
<td>103</td>
<td>REPRL_DWFD</td>
</tr>
</tbody></table>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Fuzz/" class="category-chain-item">Fuzz</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Fuzzilli/" class="print-no-link">#Fuzzilli</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Fuzilli源码解析3</div>
      <div>https://binpwn.github.io/2024/06/08/Fuzilli源码解析3/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>DingJiayu</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年6月8日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/08/30/Xcon-Kcon/" title="Xcon&amp;Kcon">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Xcon&amp;Kcon</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/06/06/Android%E6%A6%82%E5%BF%B5/" title="Android概念基础">
                        <span class="hidden-mobile">Android概念基础</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://github.com/dkjiayu" target="_blank" rel="nofollow noopener"><span>DJY</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/binpwn" target="_blank" rel="nofollow noopener"><span>ZJL</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
